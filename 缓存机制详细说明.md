# ç¼“å­˜æœºåˆ¶è¯¦ç»†è¯´æ˜

## ğŸ¯ ä½ çš„æ‹…å¿ƒæ˜¯å¯¹çš„ï¼

ä½ çš„æ‹…å¿ƒ**éå¸¸åˆç†**ï¼è®©æˆ‘è¯¦ç»†è¯´æ˜å½“å‰çš„ç¼“å­˜æœºåˆ¶å’Œæ½œåœ¨é—®é¢˜ã€‚

---

## ğŸ“Š å½“å‰ç¼“å­˜æœºåˆ¶åˆ†æ

### 1. **`analyze_fundamentals` ç¼“å­˜äº†ä»€ä¹ˆï¼Ÿ**

**ç¼“å­˜å†…å®¹**ï¼ˆè´¢åŠ¡æ•°æ®ï¼Œç›¸å¯¹ç¨³å®šï¼‰ï¼š
```python
# utils.py:1027-1040
cache_data = {
    'company_info': company_info,  # å…¬å¸åŸºæœ¬ä¿¡æ¯ï¼ˆ30å¤©ç¼“å­˜ï¼‰
    'metrics_dict': merged.to_dict('records'),  # è´¢åŠ¡æŒ‡æ ‡ï¼ˆå¹´åº¦æ•°æ®ï¼‰
    'cashflow_positive_years': int(...),  # ç°é‡‘æµç»Ÿè®¡
    'cashflow_cover_profit': bool(...),  # ç°é‡‘æµè¦†ç›–åˆ©æ¶¦
    'audit_records': [...]  # å®¡è®¡æ„è§
}
```

**âœ… ä¸åŒ…å«ä»·æ ¼æ•°æ®ï¼**
- âŒ ä¸åŒ…å« `close`ï¼ˆæ”¶ç›˜ä»·ï¼‰
- âŒ ä¸åŒ…å« `pe_ttm`ï¼ˆå¸‚ç›ˆç‡TTMï¼‰
- âŒ ä¸åŒ…å«ä»»ä½•ä¼°å€¼ç›¸å…³æ•°æ®

**ç¼“å­˜é”®**ï¼š
```python
cache_key = f"{ts_code}_{start_date_str}_{end_date_str}_{years}"
# ä¾‹å¦‚ï¼š600519_20200101_20251231_5
```

**ç¼“å­˜æ—¶é—´**ï¼š365å¤©ï¼ˆæ¥è¿‘æ°¸ä¹…ï¼‰

---

### 2. **`fetch_valuation_data` æ˜¯å¦æœ‰ç¼“å­˜ï¼Ÿ**

**ç­”æ¡ˆï¼šâŒ æ²¡æœ‰ç¼“å­˜ï¼**

**ä»£ç è¯æ®**ï¼š
```python
# utils.py:266-392
def fetch_valuation_data(ts_code: str, trade_date: str, target_type: str = "ä¸ªè‚¡"):
    # ç›´æ¥è°ƒç”¨APIï¼Œæ²¡æœ‰ä»»ä½•ç¼“å­˜é€»è¾‘
    pro = get_pro_client()
    daily_df = pro.daily_basic(...)  # è·å–æœ€æ–°ä»·æ ¼å’ŒPE
    fina_df = pro.fina_indicator(...)  # è·å–ROEå’ŒEPS
    div_df = pro.dividend(...)  # è·å–åˆ†çº¢æ•°æ®
    return {...}  # è¿”å›æœ€æ–°æ•°æ®
```

**âœ… æ¯æ¬¡è°ƒç”¨éƒ½ä¼šè·å–æœ€æ–°æ•°æ®ï¼**

---

### 3. **`check_valuation_pass` æ˜¯å¦ä½¿ç”¨ç¼“å­˜ï¼Ÿ**

**ç­”æ¡ˆï¼šâŒ ä¸ä½¿ç”¨ç¼“å­˜ï¼**

**ä»£ç æµç¨‹**ï¼š
```python
# screening.py:225-254
def check_valuation_pass(self, ts_code: str, ...):
    # 1. è·å–ä»Šå¤©æ—¥æœŸ
    today = datetime.now().strftime("%Y%m%d")
    
    # 2. è°ƒç”¨ fetch_valuation_dataï¼ˆæ²¡æœ‰ç¼“å­˜ï¼‰
    valuation_data = fetch_valuation_data(ts_code, today, "ä¸ªè‚¡")
    
    # 3. è®¡ç®—PRï¼ˆä½¿ç”¨æœ€æ–°æ•°æ®ï¼‰
    result = PRValuation.analyze_stock_valuation(valuation_data)
    
    # 4. è¿”å›ç»“æœ
    return valuation_pass, valuation_details
```

**âœ… æ¯æ¬¡ç­›é€‰éƒ½ä¼šè·å–æœ€æ–°çš„ä»·æ ¼å’ŒPEï¼**

---

## âš ï¸ æ½œåœ¨é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šå¦‚æœæœªæ¥æ·»åŠ äº†ä¼°å€¼æ•°æ®ç¼“å­˜æ€ä¹ˆåŠï¼Ÿ

**é£é™©**ï¼šå¦‚æœæœªæ¥ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œç»™ `fetch_valuation_data` æ·»åŠ äº†ç¼“å­˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä½¿ç”¨è¿‡æ—¶çš„ä»·æ ¼æ•°æ®ã€‚

**å»ºè®®**ï¼š
1. âœ… **æ˜ç¡®ç¦æ­¢ç¼“å­˜ä¼°å€¼æ•°æ®**ï¼ˆä»·æ ¼ã€PEï¼‰
2. âœ… æˆ–è€…**ä½¿ç”¨æçŸ­ç¼“å­˜**ï¼ˆå¦‚1å°æ—¶æˆ–å½“å¤©æœ‰æ•ˆï¼‰
3. âœ… åœ¨ä»£ç æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜ï¼šä¼°å€¼æ•°æ®ä¸åº”ç¼“å­˜

---

### é—®é¢˜2ï¼š`analyze_fundamentals` çš„ç¼“å­˜æ˜¯å¦ä¼šå½±å“ä¼°å€¼ï¼Ÿ

**ç­”æ¡ˆï¼šâŒ ä¸ä¼šï¼**

**åŸå› **ï¼š
- `analyze_fundamentals` åªç¼“å­˜**è´¢åŠ¡æ•°æ®**ï¼ˆèµ„äº§è´Ÿå€ºè¡¨ã€åˆ©æ¶¦è¡¨ã€ç°é‡‘æµï¼‰
- ä¼°å€¼æ£€æŸ¥ï¼ˆ`check_valuation_pass`ï¼‰**ç‹¬ç«‹è°ƒç”¨** `fetch_valuation_data`
- ä¸¤è€…**å®Œå…¨åˆ†ç¦»**ï¼Œäº’ä¸å½±å“

**æµç¨‹**ï¼š
```
1. åŸºæœ¬é¢æ£€æŸ¥
   â†“ ä½¿ç”¨ analyze_fundamentalsï¼ˆå¯èƒ½å‘½ä¸­ç¼“å­˜ï¼Œä½†åªåŒ…å«è´¢åŠ¡æ•°æ®ï¼‰
   
2. ä¼°å€¼æ£€æŸ¥
   â†“ è°ƒç”¨ check_valuation_pass
   â†“ è°ƒç”¨ fetch_valuation_dataï¼ˆæ— ç¼“å­˜ï¼Œè·å–æœ€æ–°ä»·æ ¼ï¼‰
   â†“ è®¡ç®—PRï¼ˆä½¿ç”¨æœ€æ–°ä»·æ ¼ï¼‰
```

---

## âœ… å½“å‰å®ç°æ˜¯æ­£ç¡®çš„

### éªŒè¯ä»£ç æµç¨‹

**å…¨ç½‘ç­›é€‰æµç¨‹**ï¼š
```python
# screening.py:354-396
analysis_result = analyze_fundamentals(...)  # å¯èƒ½å‘½ä¸­ç¼“å­˜ï¼ˆè´¢åŠ¡æ•°æ®ï¼‰
# â†“
fundamentals_pass, ... = self.check_fundamentals_pass(...)  # ä½¿ç”¨è´¢åŠ¡æ•°æ®
# â†“
valuation_pass, ... = self.check_valuation_pass(...)  # è°ƒç”¨ fetch_valuation_dataï¼ˆæ— ç¼“å­˜ï¼‰
```

**ç»“è®º**ï¼š
- âœ… è´¢åŠ¡æ•°æ®å¯ä»¥ä½¿ç”¨ç¼“å­˜ï¼ˆç›¸å¯¹ç¨³å®šï¼‰
- âœ… ä¼°å€¼æ•°æ®ï¼ˆä»·æ ¼ã€PEï¼‰**æ¯æ¬¡éƒ½è·å–æœ€æ–°**ï¼ˆç¬¦åˆé€»è¾‘ï¼‰

---

## ğŸ”’ å»ºè®®ï¼šæ˜ç¡®ç¦æ­¢ç¼“å­˜ä¼°å€¼æ•°æ®

ä¸ºäº†ç¡®ä¿æœªæ¥ä¸ä¼šå‡ºé—®é¢˜ï¼Œå»ºè®®ï¼š

### æ–¹æ¡ˆ1ï¼šæ·»åŠ ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£
```python
# utils.py:266
def fetch_valuation_data(ts_code: str, trade_date: str, target_type: str = "ä¸ªè‚¡"):
    """
    è·å–å¸‚èµšç‡è®¡ç®—æ‰€éœ€çš„ä¼°å€¼æ•°æ®
    
    âš ï¸ é‡è¦ï¼šæ­¤å‡½æ•°ä¸åº”ä½¿ç”¨ç¼“å­˜ï¼
    - ä»·æ ¼æ•°æ®ï¼ˆclose, pe_ttmï¼‰æ¯å¤©å˜åŒ–
    - å¿…é¡»è·å–æœ€æ–°æ•°æ®æ‰èƒ½å‡†ç¡®è®¡ç®—PR
    - å¦‚æœæ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æ—¶é—´ä¸åº”è¶…è¿‡1å°æ—¶
    """
```

### æ–¹æ¡ˆ2ï¼šæ·»åŠ çŸ­æœŸç¼“å­˜ï¼ˆå¯é€‰ï¼‰
```python
def fetch_valuation_data(ts_code: str, trade_date: str, target_type: str = "ä¸ªè‚¡", use_cache: bool = True):
    """
    å¦‚æœä½¿ç”¨ç¼“å­˜ï¼Œç¼“å­˜æ—¶é—´åº”ä¸º1å°æ—¶æˆ–å½“å¤©æœ‰æ•ˆ
    """
    if use_cache:
        cache_key = f"valuation_{ts_code}_{trade_date}"
        cached = data_cache.get(cache_key)
        if cached and is_same_day(cached['trade_date'], trade_date):
            return cached  # åŒä¸€å¤©çš„æ•°æ®å¯ä»¥ä½¿ç”¨ç¼“å­˜
    
    # è·å–æœ€æ–°æ•°æ®
    data = fetch_from_api(...)
    
    if use_cache:
        data_cache.set(cache_key, data, expire_hours=1)  # åªç¼“å­˜1å°æ—¶
    
    return data
```

---

## ğŸ“ æ€»ç»“

| æ•°æ®ç±»å‹ | æ˜¯å¦ç¼“å­˜ | ç¼“å­˜æ—¶é—´ | æ˜¯å¦åˆç† |
|---------|---------|---------|---------|
| è´¢åŠ¡æ•°æ®ï¼ˆèµ„äº§è´Ÿå€ºè¡¨ã€åˆ©æ¶¦è¡¨ã€ç°é‡‘æµï¼‰ | âœ… æ˜¯ | 365å¤© | âœ… åˆç†ï¼ˆç›¸å¯¹ç¨³å®šï¼‰ |
| å…¬å¸åŸºæœ¬ä¿¡æ¯ | âœ… æ˜¯ | 30å¤© | âœ… åˆç†ï¼ˆå¾ˆå°‘å˜åŒ–ï¼‰ |
| **ä»·æ ¼æ•°æ®ï¼ˆclose, pe_ttmï¼‰** | âŒ **å¦** | - | âœ… **åˆç†ï¼ˆæ¯å¤©å˜åŒ–ï¼‰** |
| **ROEã€EPSï¼ˆè´¢åŠ¡æŒ‡æ ‡ï¼‰** | âŒ **å¦** | - | âœ… **åˆç†ï¼ˆå­£åº¦æ›´æ–°ï¼Œä½†ä¼°å€¼æ£€æŸ¥éœ€è¦æœ€æ–°ï¼‰** |
| **åˆ†çº¢æ•°æ®** | âŒ **å¦** | - | âœ… **åˆç†ï¼ˆå¹´åº¦æ›´æ–°ï¼Œä½†éœ€è¦æœ€æ–°ï¼‰** |

**ç»“è®º**ï¼š
- âœ… **å½“å‰å®ç°æ˜¯æ­£ç¡®çš„**
- âœ… **ä¼°å€¼æ•°æ®ï¼ˆä»·æ ¼ã€PEï¼‰æ²¡æœ‰ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½è·å–æœ€æ–°**
- âœ… **ä½ çš„æ‹…å¿ƒæ˜¯åˆç†çš„ï¼Œä½†å½“å‰ä»£ç æ²¡æœ‰é—®é¢˜**
- âš ï¸ **å»ºè®®æ·»åŠ ä»£ç æ³¨é‡Šï¼Œæ˜ç¡®ç¦æ­¢ç¼“å­˜ä¼°å€¼æ•°æ®**

---

## ğŸ’¡ å»ºè®®æ”¹è¿›

1. **æ·»åŠ ä»£ç æ³¨é‡Š**ï¼šæ˜ç¡®è¯´æ˜ `fetch_valuation_data` ä¸åº”ä½¿ç”¨ç¼“å­˜
2. **æ·»åŠ æ–‡æ¡£**ï¼šåœ¨é¡¹ç›®æ–‡æ¡£ä¸­è¯´æ˜ç¼“å­˜ç­–ç•¥
3. **æ·»åŠ æµ‹è¯•**ï¼šç¡®ä¿ä¼°å€¼æ•°æ®ä¸ä¼šè¢«æ„å¤–ç¼“å­˜

**éœ€è¦æˆ‘å¸®ä½ æ·»åŠ è¿™äº›æ”¹è¿›å—ï¼Ÿ**

