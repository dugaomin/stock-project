# A股财务综合分析系统 - 项目手册

## 1. 项目概述
本项目是一个基于 Streamlit 的 A 股价值投资分析工具，旨在帮助投资者通过财务指标、估值模型和技术形态，筛选出高质量的低估值股票。系统集成了 Tushare 大数据，提供从单股深度分析到全网智能筛选的一站式解决方案。

## 2. 核心功能模块

### 2.1 🔎 单项分析 (Single Analysis)
**功能**：对单只股票进行全方位的财务体检。
**核心逻辑**：
1.  **审计意见**：一票否决制。非“标准无保留意见”直接警示。
2.  **三大核心指标**：
    *   **资产负债率**：不同行业有不同标准（如金融业放宽，制造业严格）。
    *   **毛利率**：衡量核心竞争力，要求高于行业基准。
    *   **经营现金流**：企业的血液，要求连续 3-5 年为正。
3.  **评分系统**：基于上述指标计算年度健康分（0-3分），并生成红旗警示。

**执行步骤**：
1.  在左侧导航选择“🔎 单项分析”。
2.  输入股票代码（如 `600519` 或 `茅台`）。
3.  系统自动补全后缀并获取数据。
4.  查看“审计意见”、“财务健康度”和“详细数据表”。

### 2.2 💰 市赚率估值分析 (PR Valuation)
**功能**：基于“市赚率 (PR)”模型判断买卖时机。
**核心逻辑**：
*   **市赚率 (PR)** 计算存在双重基准：
    *   **卖出/通用基准**：`PE / (ROE * 150)`。系统默认显示此值，用于判断整体估值水位和卖出时机（PR > 1.0 为高估）。
    *   **买入/严选基准**：`PE / (ROE * 100)`。用于巴菲特式严苛买入筛选（相当于通用基准下的 PR < 0.67）。
*   **修正逻辑**：考虑分红率对估值的影响。高分红（>50%）给予 1.0 系数，低分红（<25%）给予 2.0 惩罚系数。
*   **交易信号**：
    *   **PR < 1.0**：低估，建议买入。
    *   **PR > 1.0**：高估，建议持有或卖出。
*   **逆向推导**：
    *   根据当前 ROE，反推 PR=1.0（卖出价）、PR=1.5（清仓价）和 PR=0.4（强力买入价）对应的股价。
*   **K线趋势**：
    *   结合 MACD (12, 23, 8) 指标。
    *   **黄柱信号**：当 MACD 红柱变长或绿柱变短（动能增强）时显示黄柱。

**执行步骤**：
1.  选择“💰 市赚率估值分析”。
2.  输入代码。
3.  查看左侧的估值仪表盘和右侧的“巴菲特购买指标”。
4.  参考下方的 K 线图和 MACD 黄柱信号辅助决策。

### 2.3 👀 盯盘助手 (Watchlist Assistant)
**功能**：批量监控自选股，实时捕捉 MACD 金叉/死叉信号。
**核心逻辑**：
1.  **实时监控**：
    *   每 5 分钟自动刷新一次。
    *   获取实时价格拼接到日线数据末尾。
    *   计算最新 MACD，判断是否形成金叉（DIF上穿DEA）或死叉。
2.  **历史记录 (黑匣子)**：
    *   **触发机制**：当扫描到信号时，自动保存到历史记录。
    *   **去重逻辑**：
        *   **盘中**：如果同一天、同一只股票、同一种信号多次触发，系统**不会新增行**，而是更新该条记录的 **“触发次数”** 和 **“最后触发时间”**。
        *   **收盘后**：确保最后一次状态被记录。
    *   **目的**：既能看到信号触发了多少次（活跃度），又不会导致日志文件无限膨胀。

**执行步骤**：
1.  选择“👀 盯盘助手”。
2.  在文本框编辑监控股票列表（支持批量粘贴）。
3.  点击“🚀 开始扫描”。
4.  勾选“⏱️ 自动刷新”进行无人值守盯盘。
5.  切换到“📜 历史报警记录”查看或下载今日及过往的所有信号。

### 2.4 📊 全网筛选 (Market Screening)
**功能**：遍历 A 股 5000+ 只股票，筛选出符合财务和估值标准的标的。
**核心逻辑**：
*   **初筛**：剔除 ST 股、北交所股票。
*   **深筛**：
    *   ROE ≥ 10%
    *   修正市赚率 (PR) ≤ 1.0
    *   资产负债率达标
*   **并发加速**：利用多线程和缓存机制，将全网扫描时间压缩到分钟级。

**执行步骤**：
1.  选择“📊 全网筛选 (Pro)”。
2.  点击“开始全网筛选”。
3.  等待进度条完成，查看筛选结果表格。

## 3. 技术细节

### 3.1 缓存系统 (Smart Cache)
*   **位置**：`data/cache/`
*   **机制**：
    *   **永久存储**：历史财务数据默认保存 9999 天。
    *   **增量更新**：如果缓存了 2020-2022 年数据，用户请求 2020-2024 年，系统只请求 2023-2024 年数据并合并。
    *   **两阶段并发**：先快速读取缓存，再慢速请求 API，兼顾速度与稳定性。

### 3.2 数据源
*   **Tushare Pro**：提供所有基础财务和行情数据。
*   **实时接口**：`ts.get_realtime_quotes` 用于盯盘助手。

### 3.3 文件结构
*   `app.py`: 主程序入口，UI 逻辑。
*   `utils.py`: 工具库，负责 Tushare API 调用和缓存管理。
*   `valuation.py`: 估值算法核心类。
*   `data/`: 存放缓存文件和历史记录。

---
*文档更新时间：2025-11-20*
