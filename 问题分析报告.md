# 问题分析报告

## 问题1：年份获取问题（期望2020-2024，实际只获取到2020-2023）

### 现象
- **期望年份范围**：2020-2024年（5年数据）
- **实际获取年份**：2020-2023年（4年数据）
- **日志显示**：
  ```
  📅 查询日期范围：start_date=20200101, end_date=20241231
  📅 数据年份范围：2020 - 2023
  📅 期望的年份范围：2020 - 2024
  ⚠️ 警告：合并后的数据年份范围与期望范围不一致！
  ```

### 业务逻辑分析

#### 1. 代码逻辑流程
```
app.py (筛选逻辑)
  ↓
设置年份范围：start_year=2020, end_year=2024
  ↓
调用 analyze_fundamentals(ts_code, start_date="20200101", end_date="20241231")
  ↓
utils.py: analyze_fundamentals()
  ↓
调用 Tushare API：
  - balancesheet(ts_code, start_date="20200101", end_date="20241231")
  - income(ts_code, start_date="20200101", end_date="20241231")
  - cashflow(ts_code, start_date="20200101", end_date="20241231")
  ↓
Tushare API 返回数据（只包含已发布的年报）
  ↓
合并数据，发现只有2020-2023年的数据
```

#### 2. 根本原因

**年报发布时间规律**：
- 中国A股上市公司的年报通常在**次年4-5月**才发布
- 例如：2024年年报要到2025年4-5月才发布
- 当前时间：2025年1月
- **结论**：2024年年报尚未发布，Tushare API无法返回2024年的年报数据

**Tushare API行为**：
- `balancesheet`、`income`、`cashflow` 等财务数据接口返回的是**已发布的年报数据**
- 即使查询 `end_date=20241231`，也只能返回已发布的数据
- 如果2024年年报还没发布，API不会返回2024年的数据

#### 3. 数据验证逻辑

代码位置：`utils.py:644-651`
```python
# 打印合并后的数据年份范围
if not merged.empty:
    merged_years = sorted([row['end_date'][:4] for _, row in merged.iterrows()])
    print(f"📅 合并后的数据年份：{merged_years}（共{len(merged)}年）")
    print(f"📅 数据年份范围：{merged_years[0]} - {merged_years[-1]}")
    print(f"📅 期望的年份范围：{start_date[:4]} - {end_date[:4]}")
    if merged_years[0] != start_date[:4] or merged_years[-1] != end_date[:4]:
        print(f"⚠️ 警告：合并后的数据年份范围与期望范围不一致！")
```

**问题**：
- 代码只是打印警告，但没有处理这种情况
- 用户期望5年数据（2020-2024），但实际只能获取4年（2020-2023）

#### 4. 业务影响

**对筛选逻辑的影响**：
- 筛选条件要求"最近5年数据"
- 但实际只有4年数据可用
- 可能导致筛选结果不准确

**对用户期望的影响**：
- 用户期望看到2020-2024年的数据
- 但2024年数据不存在（年报未发布）
- 需要明确告知用户这是正常现象

---

## 问题2：API权限限制问题

### 现象
日志中频繁出现权限错误：
```
获取公司信息失败: 抱歉，您每分钟最多访问该接口10次，权限的具体详情访问：https://tushare.pro/document/1?doc_id=108。
查询积分信息失败: 抱歉，您每天最多访问该接口50次，权限的具体详情访问：https://tushare.pro/document/1?doc_id=108。
```

### 业务逻辑分析

#### 1. API调用频率统计

**全网筛选流程**（每只股票）：
```
1. fetch_company_info() → stock_company API（每分钟10次限制）
2. fetch_audit_records() → fina_audit API
3. fetch_balancesheet() → balancesheet API
4. fetch_income() → income API
5. fetch_cashflow() → cashflow API
```

**总股票数**：5274只
**并发线程数**：10线程
**API延迟**：0.1秒

#### 2. 权限限制详情

**stock_company API（公司信息）**：
- **限制**：每分钟最多10次
- **调用位置**：`utils.py:325-356` - `fetch_company_info()`
- **调用场景**：每只股票分析时都会调用
- **问题**：
  - 10线程并发，每线程0.1秒延迟
  - 理论上每分钟可调用：10线程 × (60秒/0.1秒) = 6000次
  - **远超限制**：6000次 >> 10次/分钟

**user API（查询积分）**：
- **限制**：每天最多50次
- **调用位置**：`utils.py:77-112` - `get_user_points_info()`
- **调用场景**：UI页面加载时调用，显示用户积分
- **问题**：
  - 每次页面刷新都会调用
  - 如果用户频繁刷新页面，很容易超过50次/天

#### 3. 代码中的延迟控制

**当前延迟设置**：
```python
# app.py: 全网筛选配置
api_delay = 0.1秒  # 用户配置的API延迟
max_workers = 10    # 并发线程数
```

**延迟计算逻辑**（`utils.py:568-582`）：
```python
# 为了避免触发频率限制，在每次API调用之间添加延迟
# 免费用户(0-119分)：每分钟2次 → 需要间隔31秒
# 注册用户(120-599分)：每分钟5次 → 间隔13秒
# 中级用户(600-4999分)：每分钟20次 → 间隔4秒
# 高级用户(5000+分)：每分钟200次 → 无需延迟
```

**问题**：
- 代码注释说明了不同用户等级的延迟要求
- 但实际使用的是用户配置的 `api_delay=0.1秒`
- **0.1秒延迟对于 `stock_company` API（每分钟10次限制）是不够的**
- 每分钟10次 = 每6秒1次，但代码只延迟0.1秒

#### 4. 并发导致的频率超限

**计算示例**：
- 10线程并发
- 每线程每只股票调用1次 `stock_company` API
- 如果10只股票同时处理，瞬间调用10次
- **超过限制**：10次 > 10次/分钟（虽然是在1分钟内，但瞬间调用会触发限制）

**实际场景**：
```
时间轴：
0.0秒：线程1-10同时启动，各调用1次 stock_company → 10次调用
0.1秒：线程1-10继续处理，各调用1次 stock_company → 又10次调用
0.2秒：线程1-10继续处理，各调用1次 stock_company → 又10次调用
...
1.0秒内：可能调用100次 stock_company API
```

#### 5. 缓存机制分析

**公司信息缓存**：
- `fetch_company_info()` 没有使用缓存
- 每次分析股票都会重新调用API
- **优化空间**：可以缓存公司信息（公司信息很少变化）

**积分信息缓存**：
- `get_user_points_info()` 有缓存机制（`app.py:1973-1978`）
- 缓存键：`user_points_info_daily`
- 缓存时间：24小时
- **问题**：日志显示缓存读取失败
  ```
  读取缓存失败 user_points_info_daily: Expecting value: line 11 column 17 (char 267)
  ```
  - 可能是缓存文件损坏或格式错误
  - 导致每次都要重新调用API，超过50次/天限制

---

## 问题总结

### 问题1：年份获取不完整
- **原因**：2024年年报尚未发布（正常现象）
- **影响**：用户期望5年数据，但只能获取4年
- **建议**：
  1. 在UI中明确提示：当前只能获取到已发布的年报数据
  2. 如果查询2024年数据，自动调整为2023年
  3. 或者允许用户选择"已发布数据"或"指定年份范围"

### 问题2：API权限限制
- **原因1**：`stock_company` API调用频率过高（10线程并发，0.1秒延迟）
- **原因2**：`user` API缓存失效，频繁调用超过50次/天
- **影响**：API调用失败，影响筛选进度
- **建议**：
  1. 为 `stock_company` API增加专用延迟（至少6秒/次）
  2. 修复 `user_points_info_daily` 缓存读取问题
  3. 为 `fetch_company_info()` 增加缓存机制
  4. 在全网筛选中，考虑降低并发数或增加延迟

---

## 业务建议

### 1. 年份范围处理
- **自动调整**：如果查询年份包含未发布的年报，自动调整为已发布的最新年份
- **用户提示**：明确告知用户当前可用的数据年份范围
- **灵活配置**：允许用户选择"最近N年已发布数据"或"指定年份范围"

### 2. API调用优化
- **分层延迟**：不同API使用不同的延迟策略
  - `stock_company`：6秒/次（每分钟10次限制）
  - 其他财务数据API：根据用户等级设置延迟
- **缓存增强**：
  - `fetch_company_info()` 增加缓存（公司信息很少变化）
  - 修复 `user_points_info_daily` 缓存问题
- **并发控制**：
  - 对于有限制的API，使用队列机制，确保不超过频率限制
  - 或者降低并发数，增加延迟

### 3. 错误处理
- **优雅降级**：API调用失败时，使用缓存数据或跳过该股票
- **重试机制**：对于频率限制错误，自动等待后重试
- **用户反馈**：明确告知用户API限制情况，建议调整参数

