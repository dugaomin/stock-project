# A股全网筛选系统 - 项目逻辑详解

本文档详细解释了本项目的核心业务逻辑、模块分工、数据字段及计算公式，旨在帮助开发者快速理解系统运作机制。

## 1. 项目概览

本项目是一个基于 **巴菲特价值投资理念** 的A股全网筛选系统。其核心目标是从全市场5000+只股票中，筛选出具有长期投资价值的优质标的。

**筛选核心指标：**
*   **基本面**：财务健康，无造假风险（审计意见、现金流）。
*   **估值**：价格合理（修正市赚率 PR）。

---

## 2. 模块分工与逻辑

项目主要由以下几个核心模块组成：

### 2.1 `app.py` (用户交互层)
*   **功能**：基于 Streamlit 构建的 Web 界面。
*   **逻辑**：
    *   提供侧边栏导航（单股分析、全网筛选、指数估值）。
    *   **单股分析**：输入代码，展示详细的财务报表、估值计算过程和历史走势。
    *   **全网筛选**：配置筛选参数（PR阈值、ROE要求），启动多线程筛选任务，实时展示进度和结果。
    *   **指数估值**：展示宽基指数的估值水位。

### 2.2 `screening.py` (筛选核心层)
*   **功能**：执行全网扫描和筛选逻辑。
*   **逻辑**：
    1.  **获取股票列表**：调用 Tushare `stock_basic` 接口，获取全市场股票，排除 ST 股。
    2.  **并发分析**：使用 `ThreadPoolExecutor` 多线程并发处理每只股票，提高效率。
    3.  **双重筛选**：
        *   **第一层：基本面筛选**（调用 `check_fundamentals_pass`）。
        *   **第二层：估值筛选**（调用 `check_valuation_pass`）。
    4.  **排序与输出**：将通过筛选的股票按 **修正市赚率 (PR)** 从低到高排序。

### 2.3 `valuation.py` (估值计算层)
*   **功能**：核心估值算法实现。
*   **逻辑**：
    *   实现 **修正市赚率 (Corrected PR)** 的计算公式。
    *   处理分红对估值的影响（修正系数 N）。
    *   计算宽基指数的估值。

### 2.4 `utils.py` (数据获取与处理层)
*   **功能**：封装 Tushare API，处理数据清洗、合并和基础指标计算。
*   **逻辑**：
    *   **智能缓存**：对 API 返回的数据进行本地文件缓存（默认24小时，公司信息30天），减少 API 调用，加快二次运行速度。
    *   **API 频率控制**：根据用户积分等级，自动计算 API 调用延迟，避免触发限流。
    *   **数据合并**：将资产负债表、利润表、现金流量表按年份（`end_date`）进行合并。

---

## 3. 详细业务逻辑与字段解析

### 3.1 数据获取 (Fields Fetched)

系统主要通过 `utils.py` 调用 Tushare Pro API 获取以下数据：

| 数据类别 | API 接口 | 关键字段 (Fields) | 用途 |
| :--- | :--- | :--- | :--- |
| **每日指标** | `daily_basic` | `pe_ttm` (滚动市盈率)<br>`close` (收盘价) | 计算基础估值 |
| **财务指标** | `fina_indicator` | `roe_waa` (加权净资产收益率)<br>`eps` (每股收益) | 计算 ROE 和分红支付率 |
| **分红数据** | `dividend` | `cash_div` (每股派息) | 计算股息支付率 |
| **审计意见** | `fina_audit` | `audit_result` (审计结论) | 基本面排雷 |
| **资产负债表** | `balancesheet` | `total_assets` (总资产)<br>`total_liab` (总负债) | 计算资产负债率 |
| **利润表** | `income` | `revenue` (营业收入)<br>`oper_cost` (营业成本)<br>`n_income` (净利润) | 计算毛利率、净利润 |
| **现金流量表** | `cashflow` | `n_cashflow_act` (经营活动现金净流量) | 验证盈利质量 |

### 3.2 核心计算公式 (Calculations)

#### A. 修正市赚率 (Corrected PR)
这是本系统的核心估值指标，计算过程如下：

1.  **标准市赚率 (Standard PR)**
    $$ PR_{std} = \frac{PE_{TTM}}{ROE \times 150} $$
    *   注：代码中分母为 `ROE * 150` (根据 `valuation.py` 中的 `STOCK_PR_DENOMINATOR = 150`)。
    *   逻辑：衡量“回本年限”与“资产增值速度”的性价比。

2.  **股息支付率 (Payout Ratio)**
    $$ Ratio = \frac{Dividend}{EPS} $$

3.  **修正系数 (N)**
    根据股息支付率调整估值认可度：
    *   若 $Ratio \ge 50\%$：$N = 1.0$ (分红大方，认可其估值)
    *   若 $Ratio \le 25\%$：$N = 2.0$ (铁公鸡，估值打折，即PR翻倍)
    *   若 $25\% < Ratio < 50\%$：$N = \frac{0.5}{Ratio}$ (线性过渡)

4.  **修正市赚率 (Final PR)**
    $$ PR_{final} = PR_{std} \times N $$

#### B. 基本面指标
*   **资产负债率** = `total_liab` / `total_assets`
*   **毛利率** = (`revenue` - `oper_cost`) / `revenue`
*   **现金流覆盖率** = `n_cashflow_act` >= `n_income` (判断利润是否是真金白银)

### 3.3 筛选规则 (Screening Rules)

一只股票必须 **同时满足** 以下所有条件才能通过筛选：

#### 第一层：基本面 (Fundamental Check)
1.  **审计意见**：最近 5 年的审计结果必须全部为 **"标准无保留意见"**。
    *   *逻辑：排除有财务造假嫌疑或经营重大不确定性的公司。*
2.  **现金流质量**：
    *   最近 5 年的 **经营活动现金净流量** 必须全部 $\ge 0$。
    *   最近 5 年的 **经营活动现金净流量** 必须全部 $\ge$ **净利润**。
    *   *逻辑：确保公司主营业务具备持续造血能力，且利润转化为真金白银。*

#### 第二层：估值 (Valuation Check)
1.  **修正市赚率 (PR)**：$PR_{final} \le$ 用户设定的阈值 (默认 1.0)。
    *   *逻辑：只买价格合理或低估的股票。*
2.  **ROE 要求**：$ROE_{waa} \ge$ 用户设定的最小值 (如 10%)。
    *   *逻辑：确保公司具备一定的盈利能力。*

---

## 4. 总结

整个系统的逻辑链条是：
1.  **海选**：拿全市场股票。
2.  **排雷**：用审计意见和现金流剔除垃圾股。
3.  **估值**：用修正市赚率（考虑PE、ROE和分红）找到低估值好股。
4.  **决策**：输出清单供投资者参考。
