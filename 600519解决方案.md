# 600519ç­›é€‰é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æ€»ç»“

**æ ¸å¿ƒé—®é¢˜**ï¼š600519åœ¨å…¨ç½‘ç­›é€‰å’Œå•é¡¹åˆ†æä¸­éƒ½**æœªé€šè¿‡**ï¼Œä¸æ˜¯Bugï¼Œè€Œæ˜¯ç”±äºï¼š
1. **å½“å‰æ—¶é—´**ï¼š2025å¹´11æœˆ
2. **å¹´ä»½è®¡ç®—**ï¼šç³»ç»Ÿè®¡ç®—å‡ºæŸ¥è¯¢èŒƒå›´ä¸º2020-2024å¹´ï¼ˆéœ€è¦5å¹´ï¼‰
3. **å®é™…æ•°æ®**ï¼šTushareåªæœ‰2020-2023å¹´çš„æ•°æ®ï¼ˆ4å¹´ï¼‰ï¼Œ2024å¹´å¹´æŠ¥æœªæ›´æ–°
4. **ç­›é€‰é€»è¾‘**ï¼šä¸¥æ ¼è¦æ±‚5å¹´å®Œæ•´æ•°æ®ï¼Œå®é™…åªæœ‰4å¹´ï¼Œå› æ­¤æœªé€šè¿‡

## æ¨èè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¼˜åŒ–å¹´ä»½è®¡ç®—é€»è¾‘ï¼ˆæ¨èï¼‰â­

ä¿®æ”¹ `utils.py` ä¸­çš„ `calculate_recent_years` å‡½æ•°ï¼Œä½¿ç”¨æ›´ä¿å®ˆçš„åˆ¤æ–­é€»è¾‘ï¼š

```python
def calculate_recent_years(required_years: int = 5) -> Tuple[int, int]:
    """
    æ™ºèƒ½è®¡ç®—"æœ€è¿‘Nå¹´"çš„å¹´ä»½èŒƒå›´,è€ƒè™‘å¹´æŠ¥å‘å¸ƒæ—¶é—´å’Œæ•°æ®æºæ›´æ–°æ»å
    
    é€»è¾‘:
    - å¹´æŠ¥é€šå¸¸åœ¨æ¬¡å¹´4-5æœˆå‘å¸ƒ
    - æ•°æ®æºå¯èƒ½æœ‰1-3ä¸ªæœˆçš„æ›´æ–°æ»å
    - ä¿å®ˆä¼°è®¡ï¼š8æœˆä¹‹åæ‰è®¤ä¸ºä¸Šä¸€å¹´å¹´æŠ¥æ•°æ®å·²åœ¨æ•°æ®æºä¸­å®Œå…¨æ›´æ–°
    
    ä¾‹å­:
    - 2026å¹´1æœˆ,éœ€è¦5å¹´: è¿”å› (2017, 2021) - å› ä¸º2022å¹´æŠ¥å¯èƒ½æœªæ›´æ–°
    - 2026å¹´8æœˆ,éœ€è¦5å¹´: è¿”å› (2018, 2022) - å› ä¸º2022å¹´æŠ¥åº”è¯¥å·²æ›´æ–°
    - 2026å¹´11æœˆ,éœ€è¦5å¹´: è¿”å› (2018, 2022) - ä¿å®ˆç­–ç•¥,é¿å…æ•°æ®ä¸è¶³
    """
    current_year = datetime.now().year
    current_month = datetime.now().month
    
    # æ›´ä¿å®ˆçš„åˆ¤æ–­ï¼šè€ƒè™‘æ•°æ®æºæ›´æ–°æ»å
    # 8æœˆä¹‹å‰ï¼šä½¿ç”¨å‰å¹´ä½œä¸ºç»“æŸå¹´ä»½
    # 8æœˆä¹‹åï¼šä½¿ç”¨ä¸Šä¸€å¹´ä½œä¸ºç»“æŸå¹´ä»½
    if current_month >= 8:
        # 8æœˆåŠä¹‹å,ä¸Šä¸€å¹´å¹´æŠ¥åº”è¯¥å·²åœ¨æ•°æ®æºä¸­æ›´æ–°
        end_year = current_year - 1
    else:
        # 1-7æœˆ,ä¸Šä¸€å¹´å¹´æŠ¥å¯èƒ½è¿˜æœªåœ¨æ•°æ®æºä¸­å®Œå…¨æ›´æ–°
        end_year = current_year - 2
    
    start_year = end_year - required_years + 1
    
    print(f"ğŸ“… æ™ºèƒ½å¹´ä»½è®¡ç®—ï¼ˆä¿å®ˆæ¨¡å¼ï¼‰: å½“å‰{current_year}å¹´{current_month}æœˆ,æœ€è¿‘{required_years}å¹´ = {start_year}-{end_year}")
    
    return start_year, end_year
```

**ä¼˜ç‚¹**:
- æ ¹æœ¬æ€§è§£å†³é—®é¢˜ï¼Œé¿å…æŸ¥è¯¢æ•°æ®æºä¸­å°šæœªæ›´æ–°çš„æ•°æ®
- é€‚ç”¨äºæ‰€æœ‰è‚¡ç¥¨ï¼Œæé«˜ç­›é€‰æˆåŠŸç‡
- ä¿æŒç­›é€‰é€»è¾‘çš„ä¸¥æ ¼æ€§ï¼ˆä»ç„¶è¦æ±‚5å¹´å®Œæ•´æ•°æ®ï¼‰

**ç¼ºç‚¹**:
- åœ¨8-12æœˆæœŸé—´ï¼Œä¼šå°‘æŸ¥è¯¢ä¸€å¹´çš„æ•°æ®ï¼ˆä½¿ç”¨2020-2024è€Œä¸æ˜¯2021-2025ï¼‰
- ä½†è¿™æ˜¯åˆç†çš„æƒè¡¡ï¼Œå› ä¸ºæ•°æ®æºç¡®å®æ²¡æœ‰æœ€æ–°ä¸€å¹´çš„æ•°æ®

### æ–¹æ¡ˆ2: æ™ºèƒ½æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ï¼ˆå¤‡é€‰ï¼‰

ä¿®æ”¹ `screening.py` ä¸­çš„ `check_fundamentals_pass` å‡½æ•°ï¼Œå…è®¸é™çº§ç­›é€‰ï¼š

```python
def check_fundamentals_pass(self,
                           audit_records: List[AuditRecord],
                           metrics: pd.DataFrame,
                           required_years: int = 5,
                           allow_downgrade: bool = True) -> Tuple[bool, Dict]:
    """
    æ£€æŸ¥åŸºæœ¬é¢ç­›é€‰æ¡ä»¶
    
    å‚æ•°:
        allow_downgrade: æ˜¯å¦å…è®¸é™çº§ç­›é€‰ï¼ˆå½“æ•°æ®ä¸è¶³5å¹´ä½†è‡³å°‘æœ‰3-4å¹´æ—¶ï¼‰
    """
    results = {
        'audit_pass': False,
        'cashflow_pass': False,
        'cashflow_ge_profit': False,
        'data_sufficiency_pass': False,
        'audit_details': [],
        'cashflow_details': {}
    }

    # æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
    if not metrics.empty:
        years_found = len(metrics)
        
        # ä¸¥æ ¼æ¨¡å¼ï¼šå¿…é¡»æ»¡è¶³required_years
        if years_found >= required_years:
            results['data_sufficiency_pass'] = True
        # é™çº§æ¨¡å¼ï¼šå¦‚æœæœ‰è‡³å°‘3å¹´æ•°æ®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ï¼ˆä½†ä¼šæ ‡è®°ï¼‰
        elif allow_downgrade and years_found >= max(3, required_years - 1):
            results['data_sufficiency_pass'] = True
            results['data_sufficiency_msg'] = f"é™çº§ç­›é€‰ï¼šéœ€è¦{required_years}å¹´ï¼Œå®é™…{years_found}å¹´ï¼ˆå·²é™çº§ï¼‰"
            results['is_downgraded'] = True
            print(f"âš ï¸ é™çº§ç­›é€‰ï¼šè¯·æ±‚{required_years}å¹´ï¼Œå®é™…{years_found}å¹´ï¼Œé™çº§é€šè¿‡")
        else:
            results['data_sufficiency_pass'] = False
            results['data_sufficiency_msg'] = f"æ•°æ®ä¸è¶³ï¼šéœ€è¦{required_years}å¹´ï¼Œå®é™…åªæœ‰{years_found}å¹´"
    else:
        results['data_sufficiency_pass'] = False
        results['data_sufficiency_msg'] = "æ— è´¢åŠ¡æ•°æ®"

    # å¦‚æœæ•°æ®ä¸è¶³ä¸”ä¸å…è®¸é™çº§ï¼Œç›´æ¥è¿”å›ä¸é€šè¿‡
    if not results['data_sufficiency_pass']:
        return False, results
    
    # ... å…¶ä½™é€»è¾‘ä¿æŒä¸å˜ ...
```

**ä¼˜ç‚¹**:
- çµæ´»å¤„ç†æ•°æ®ä¸è¶³çš„æƒ…å†µ
- å¯ä»¥è®©æ›´å¤šè‚¡ç¥¨é€šè¿‡ç­›é€‰ï¼ˆå¦‚600519ï¼‰

**ç¼ºç‚¹**:
- é™ä½äº†ç­›é€‰æ ‡å‡†çš„ä¸¥æ ¼æ€§
- å¯èƒ½å¼•å…¥è´¨é‡ä¸å¤Ÿé«˜çš„è‚¡ç¥¨

### æ–¹æ¡ˆ3: ä¸´æ—¶æ‰‹åŠ¨è°ƒæ•´ï¼ˆå¿«é€ŸéªŒè¯ï¼‰

å¦‚æœç”¨æˆ·æƒ³ç«‹å³éªŒè¯600519ï¼Œå¯ä»¥ä¸´æ—¶ä¿®æ”¹å‚æ•°ï¼š

åœ¨ `app.py` æˆ– `screening.py` ä¸­ï¼š
```python
# ä¸´æ—¶ä¿®æ”¹ï¼šä½¿ç”¨2019-2023å¹´çš„5å¹´æ•°æ®ï¼Œè€Œä¸æ˜¯2020-2024
current_year = datetime.now().year  # 2025
start_year = current_year - 6  # 2019
end_year = current_year - 2     # 2023
required_years = 5              # ä¿æŒ5å¹´
```

**ä¼˜ç‚¹**:
- ç«‹å³å¯ç”¨ï¼Œæ— éœ€ç­‰å¾…
- å¯ä»¥éªŒè¯600519çš„è´¢åŠ¡è´¨é‡

**ç¼ºç‚¹**:
- ä¸´æ—¶æ–¹æ¡ˆï¼Œä¸æ˜¯é•¿æœŸè§£å†³æ–¹æ¡ˆ
- æ•°æ®ä¸æ˜¯"æœ€è¿‘5å¹´"è€Œæ˜¯"ç¨æ—©çš„5å¹´"

## å®æ–½å»ºè®®

1. **ç«‹å³å®æ–½æ–¹æ¡ˆ1**ï¼ˆä¼˜åŒ–å¹´ä»½è®¡ç®—é€»è¾‘ï¼‰
   - è¿™æ˜¯æ ¹æœ¬æ€§è§£å†³æ–¹æ¡ˆ
   - ä¿®æ”¹ä¸€å¤„ä»£ç ï¼Œå…¨å±€ç”Ÿæ•ˆ
   - å‰¯ä½œç”¨å°ï¼Œé€»è¾‘åˆç†

2. **å¯é€‰å®æ–½æ–¹æ¡ˆ2**ï¼ˆæ™ºèƒ½é™çº§ï¼‰
   - ä½œä¸ºæ–¹æ¡ˆ1çš„è¡¥å……
   - ç»™ç”¨æˆ·æ›´å¤šçµæ´»æ€§
   - ä½†éœ€è¦åœ¨UIä¸­æ˜ç¡®æ ‡è¯†"é™çº§ç­›é€‰"

3. **ä¸æ¨èæ–¹æ¡ˆ3**ï¼ˆä¸´æ—¶è°ƒæ•´ï¼‰
   - ä»…ç”¨äºå¿«é€ŸéªŒè¯
   - ä¸é€‚åˆé•¿æœŸä½¿ç”¨

## ä»£ç ä¿®æ”¹ä½ç½®

### æ–¹æ¡ˆ1: ä¿®æ”¹å¹´ä»½è®¡ç®—
- æ–‡ä»¶: `utils.py`
- å‡½æ•°: `calculate_recent_years`
- è¡Œå·: 815-849

### æ–¹æ¡ˆ2: ä¿®æ”¹æ•°æ®æ£€æŸ¥
- æ–‡ä»¶: `screening.py`
- å‡½æ•°: `check_fundamentals_pass`
- è¡Œå·: 121-223

## é¢„æœŸæ•ˆæœ

å®æ–½æ–¹æ¡ˆ1åï¼š
- åœ¨2025å¹´11æœˆï¼Œå¹´ä»½èŒƒå›´å°†å˜ä¸º **2019-2023**ï¼ˆè€Œä¸æ˜¯2020-2024ï¼‰
- 600519å°†è·å¾—5å¹´å®Œæ•´æ•°æ®ï¼ˆ2019-2023ï¼‰
- åŸºæœ¬é¢ç­›é€‰å°†**é€šè¿‡**âœ…
- ä¼°å€¼ç­›é€‰å·²ç»é€šè¿‡ï¼ˆPR=0.55, ROE=24.64%ï¼‰
- ç»¼åˆåˆ¤æ–­å°†**é€šè¿‡**âœ…

## éªŒè¯æ–¹æ³•

ä¿®æ”¹åï¼Œé‡æ–°è¿è¡Œ `debug_600519.py`ï¼š
```bash
python3 debug_600519.py
```

é¢„æœŸè¾“å‡ºï¼š
```
è´¢åŠ¡æŒ‡æ ‡å¹´ä»½: ['2023', '2022', '2021', '2020', '2019']
å…±5å¹´ï¼Œâœ…å……è¶³ (éœ€è¦5å¹´)

æ•°æ®å®Œæ•´æ€§: âœ… (5å¹´æ•°æ®)
åŸºæœ¬é¢ç­›é€‰: âœ… é€šè¿‡
ä¼°å€¼ç­›é€‰: âœ… é€šè¿‡
ç»¼åˆåˆ¤æ–­: âœ… é€šè¿‡ç­›é€‰
```
