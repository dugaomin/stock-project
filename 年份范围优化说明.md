# 📅 年份范围优化说明

## ✅ 已完成的优化

### 优化内容

**问题**：之前年份范围是固定的2018-2023年，不够灵活

**优化**：改为动态获取年份范围
- **开始年份**：固定为 **2000年**
- **结束年份**：动态获取 **当前年份**（如2025年）

---

## 🔧 修改位置

### 1. `screening.py` - 筛选核心模块

#### 修改1：`screen_all_stocks()` 函数
```python
# 修改前
start_year: int = 2018,
end_year: int = 2023,

# 修改后
start_year: int = None,  # 动态获取，默认2000年
end_year: int = None,  # 动态获取，默认当前年份
```

**添加逻辑**：
```python
# 在执行筛选前动态获取当前年份
if end_year is None:
    end_year = datetime.now().year  # 使用当前年份（如2025年）
if start_year is None:
    start_year = 2000  # 从2000年开始
```

#### 修改2：`analyze_single_stock()` 函数
```python
# 修改前
start_year: int = 2018,
end_year: int = 2023,

# 修改后
start_year: int = None,  # 动态获取，默认2000年
end_year: int = None,  # 动态获取，默认当前年份
```

**添加逻辑**：
```python
# 在执行分析前动态获取当前年份
if end_year is None:
    end_year = datetime.now().year  # 使用当前年份（如2025年）
if start_year is None:
    start_year = 2000  # 从2000年开始
```

#### 修改3：`run_full_market_screening()` 函数
```python
# 修改前
start_year: int = 2018,
end_year: int = 2023,

# 修改后
start_year: int = None,  # 动态获取，默认2000年
end_year: int = None,  # 动态获取，默认当前年份
```

**添加逻辑**：
```python
# 在执行筛选前动态获取当前年份
if end_year is None:
    end_year = datetime.now().year  # 使用当前年份（如2025年）
if start_year is None:
    start_year = 2000  # 从2000年开始
```

---

### 2. `app.py` - 主应用界面

#### 修改1：筛选参数显示
```python
# 修改前
end_year = datetime.now().year - 1
start_year = end_year - years + 1

# 修改后
current_year = datetime.now().year  # 获取当前年份（如2025年）
start_year = 2000  # 从2000年开始
end_year = current_year  # 到当前年份
```

#### 修改2：单只股票分析
```python
# 修改前
start_date = f"{start_year}0101"
end_date = f"{end_year}1231"

# 修改后
current_year = datetime.now().year  # 获取当前年份
analysis_start_year = 2000  # 从2000年开始
analysis_end_year = current_year  # 到当前年份

start_date = f"{analysis_start_year}0101"
end_date = f"{analysis_end_year}1231"
```

---

## 📊 年份范围说明

### 筛选年份范围

**开始年份**：**2000年**（固定）
- 从2000年开始获取财务数据
- 确保获取足够长的历史数据

**结束年份**：**当前年份**（动态）
- 自动获取当前年份（如2025年）
- 每年自动更新，无需手动修改

**示例**：
- 2025年执行筛选：**2000年 - 2025年**（共26年）
- 2026年执行筛选：**2000年 - 2026年**（共27年）

---

## 🎯 业务逻辑

### 筛选流程

```
开始筛选
    ↓
获取当前年份（如2025年）
    ↓
设置年份范围：2000年 - 2025年
    ↓
对每只股票执行分析
    ├─ 获取2000-2025年的财务数据
    ├─ 检查近5年审计意见（从最新年份往前推5年）
    ├─ 检查近5年现金流（从最新年份往前推5年）
    └─ 计算修正市赚率（使用最新数据）
    ↓
应用筛选规则
    ↓
输出结果
```

### 数据获取范围

**财务数据**：2000年 - 当前年份
- 获取尽可能长的历史数据
- 确保有足够的数据进行筛选

**筛选检查**：近5年（从当前年份往前推）
- 审计意见：检查最近5年
- 现金流：检查最近5年
- 估值数据：使用最新交易日数据

---

## ✅ 优化效果

### 优势

1. **自动更新**：
   - 结束年份自动使用当前年份
   - 无需每年手动修改代码

2. **数据完整**：
   - 从2000年开始，获取25年+的历史数据
   - 确保有足够的数据进行分析

3. **筛选准确**：
   - 使用最新年份的数据
   - 确保筛选结果是最新的

### 年份范围对比

| 项目 | 优化前 | 优化后 |
|------|--------|--------|
| 开始年份 | 2018年（固定） | 2000年（固定） |
| 结束年份 | 2023年（固定） | 当前年份（动态，如2025年） |
| 数据范围 | 6年 | 25年+ |
| 自动更新 | ❌ 需要手动修改 | ✅ 自动更新 |

---

## 🔍 代码验证

### 验证点

1. ✅ `screen_all_stocks()` 在执行前获取当前年份
2. ✅ `analyze_single_stock()` 在执行前获取当前年份
3. ✅ `run_full_market_screening()` 在执行前获取当前年份
4. ✅ `app.py` 中筛选逻辑使用2000年-当前年份
5. ✅ 所有年份参数都正确传递

---

## 📝 使用说明

### 自动使用

筛选功能会自动使用：
- **开始年份**：2000年
- **结束年份**：当前年份（如2025年）

**无需任何配置**，系统会自动获取当前年份。

### 显示信息

在筛选界面会显示：
```
📊 筛选参数：年份范围=2000年-2025年（共26年），ROE≥10.0%，PR≤1.0
```

---

## ⚠️ 注意事项

1. **数据量增加**：
   - 从2000年开始，数据量比之前（2018年开始）大很多
   - 首次筛选可能需要更长时间建立缓存

2. **API调用增加**：
   - 年份范围更大，可能需要更多API调用
   - 但缓存机制会减少重复调用

3. **筛选标准不变**：
   - 仍然检查近5年的审计意见和现金流
   - 只是数据获取范围更广

---

**优化完成时间**：2025-01-XX  
**年份范围**：2000年 - 当前年份（自动更新）

