# 600519（贵州茅台）筛选问题分析报告

## 问题描述
用户反馈：600519 在全网筛选中不通过，但手动使用🔎单项分析方法可以筛选通过。

## 调查结果

### 关键发现
**实际上两种方法结果是一致的！都是未通过筛选！**

通过 `debug_600519.py` 脚本的详细测试，我们发现：
- **方法1（单项分析）**: ❌ 未通过筛选
- **方法2（全网筛选）**: ❌ 未通过筛选
- **结论**: 两种方法结果完全一致

### 根本原因

#### 1. 数据不足问题
```
财务指标年份: ['2023', '2022', '2021', '2020']
共4年，❌不足 (需要5年)

数据完整性: ❌ 数据不足：需要5年，实际只有4年
```

**关键问题**: 当前是 **2025年11月**，但是：
- 系统查询年份范围：2020-2024（需要5年数据）
- 实际获取到的数据：只有2020-2023（4年数据）
- **2024年年报尚未在数据源中更新**

#### 2. 年份计算逻辑（utils.py 中的 `calculate_recent_years`）

```python
def calculate_recent_years(required_years: int = 5) -> Tuple[int, int]:
    current_year = datetime.now().year  # 2025
    current_month = datetime.now().month  # 11
    
    # 判断上一年的年报是否已发布
    if current_month >= 5:
        # 5月及之后，上一年年报应该已发布
        end_year = current_year - 1  # 2024
    else:
        # 1-4月，上一年年报可能未发布，往前推一年
        end_year = current_year - 2
    
    start_year = end_year - required_years + 1  # 2020
    
    return start_year, end_year  # (2020, 2024)
```

**问题分析**:
- 当前是2025年11月，按逻辑 `end_year = 2024`
- 系统认为2024年报应该已经发布（因为11月>=5月）
- 但**实际上Tushare数据源中2024年年报还没有更新**
- 导致查询 `end_date <= 20241231` 时，只能获取到2020-2023年的4年数据

#### 3. 筛选逻辑（screening.py 中的 `check_fundamentals_pass`）

```python
def check_fundamentals_pass(self, audit_records, metrics, required_years=5):
    # 数据完整性检查
    if not metrics.empty:
        years_found = len(metrics)
        if years_found >= required_years:  # 需要 >= 5
            results['data_sufficiency_pass'] = True
        else:
            results['data_sufficiency_pass'] = False
            results['data_sufficiency_msg'] = f"数据不足：需要{required_years}年，实际只有{years_found}年"
    
    # 如果数据不足，直接返回不通过
    if not results['data_sufficiency_pass']:
        return False, results
```

**严格的数据完整性检查**:
- 要求必须有5年完整数据才能通过基本面筛选
- 600519只有4年数据（2020-2023）
- 因此基本面筛选 ❌ 未通过
- 即使估值筛选通过（PR=0.55, ROE=24.64%），综合判断也是未通过

## 用户的误解

用户提到"手动去筛选数据了调用🔎单项分析等方法查过了可以筛选过"，这可能是因为：

1. **查看了历史数据但没有注意到"数据不足"的提示**
   - 单项分析界面可能展示了贵州茅台的优秀财务指标
   - 但在底层逻辑中，因为数据年数不足，基本面筛选仍然是未通过的

2. **混淆了"数据展示"和"筛选通过"**
   - 单项分析会展示所有能获取到的数据（4年）
   - 但这不代表股票通过了筛选条件
   - 只有满足5年完整数据的要求，才算通过基本面筛选

3. **只关注了估值指标**
   - 估值筛选确实是通过的（PR=0.55 < 1.0, ROE=24.64% > 10%）
   - 但综合筛选需要"基本面通过 AND 估值通过"
   - 由于基本面未通过，最终结果是未通过

## 解决方案

### 方案1：等待数据更新（推荐）
- 等待Tushare数据源更新2024年年报数据
- 预计时间：2025年4-5月（上市公司年报披露截止日期后）
- 届时缓存会自动刷新，600519将获得5年完整数据

### 方案2：调整年份范围为4年（临时方案）
修改筛选参数，将 `required_years` 从5改为4：
```python
# 在 screening.py 的 screen_all_stocks 中
current_year = datetime.now().year  # 2025
start_year = current_year - 5  # 2020
end_year = current_year - 2     # 2023（而不是2024）
required_years = 4              # 改为4年
```

这样可以：
- 查询2020-2023年的数据（4年）
- 与实际可获得的数据年数匹配
- 600519将通过基本面筛选

### 方案3：放宽数据完整性要求
修改 `check_fundamentals_pass` 的逻辑：
```python
# 允许至少有4年数据即可通过
if years_found >= max(3, required_years - 1):  # 至少3年或required_years-1年
    results['data_sufficiency_pass'] = True
```

## 技术细节总结

### 无Bug，设计如预期
- **全网筛选方法正确**：严格按照5年数据要求进行筛选
- **单项分析方法正确**：同样遵循5年数据要求
- **两种方法结果一致**：都是未通过筛选

### 问题本质
- **数据源时效性**：2024年年报尚未在Tushare中更新
- **年份计算假设**：代码假设"11月时上一年年报已发布"，但实际情况可能滞后

### 建议优化

#### 智能年份计算优化
```python
def calculate_recent_years(required_years: int = 5) -> Tuple[int, int]:
    current_year = datetime.now().year
    current_month = datetime.now().month
    
    # 更保守的假设：8月之后才认为上一年年报已发布
    # 因为数据源可能有滞后
    if current_month >= 8:
        end_year = current_year - 1
    else:
        end_year = current_year - 2
    
    start_year = end_year - required_years + 1
    
    return start_year, end_year
```

#### 动态数据完整性检查
```python
# 如果请求5年但只获得4年数据，自动降级到4年筛选
actual_years = len(metrics)
effective_years = min(required_years, actual_years)

# 如果有至少3年数据，降级执行筛选
if actual_years >= 3:
    print(f"⚠️ 降级筛选：请求{required_years}年，实际{actual_years}年")
    required_years = actual_years
```

## 结论

**600519在全网筛选和单项分析中都是未通过的，原因是2024年年报数据尚未更新，导致只有4年数据而不足5年要求。这不是Bug，而是数据源更新滞后和年份计算假设的问题。**

用户需要：
1. 等待2024年年报数据更新（推荐）
2. 或者临时调整筛选年份为4年
3. 或者放宽数据完整性要求

---

生成时间: 2025-11-25
调试脚本: debug_600519.py
