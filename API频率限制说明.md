# Tushare API频率限制规则说明

## 重要理解

### 频率限制是**全局限制**，不是每个线程的限制

Tushare的频率限制是**所有线程加起来的总限制**，不是每个线程单独的限制。

## 您的积分等级（2000分 = 中级用户）

根据Tushare文档，2000分属于**中级用户（600-4999分）**，频率限制如下：

| API类型 | 全局限制（所有线程合计） | 说明 |
|---------|----------------------|------|
| 财务数据API | 每分钟200次 | fina_audit, balancesheet, income, cashflow等 |
| stock_company | 每分钟10次 | 公司基本信息（特殊限制，无论积分等级） |
| user | 每天50次 | 查询积分信息 |

## 延迟计算逻辑

### 计算公式

**每个线程的延迟 = 60秒 / (全局限制次数 / 并发线程数)**

### 实际示例（2000分中级用户）

#### 财务数据API（每分钟200次）

| 并发线程数 | 每个线程每分钟可调用 | 每个线程延迟 | 说明 |
|-----------|-------------------|------------|------|
| 1线程 | 200次 | 0.3秒 | 单线程最快 |
| 5线程 | 40次 | 1.5秒 | 5线程并发 |
| 10线程 | 20次 | 3.0秒 | 10线程并发（默认） |
| 20线程 | 10次 | 6.0秒 | 20线程并发 |

#### stock_company API（每分钟10次，特殊限制）

| 并发线程数 | 每个线程每分钟可调用 | 每个线程延迟 | 说明 |
|-----------|-------------------|------------|------|
| 1线程 | 10次 | 6.0秒 | 单线程 |
| 5线程 | 2次 | 30.0秒 | 5线程并发（很慢） |
| 10线程 | 1次 | 60.0秒 | 10线程并发（太慢） |

**注意**：`stock_company` API限制很严格，多线程并发时延迟会大幅增加。因此我们使用**保守策略**：无论线程数多少，都保持6秒延迟（单线程的延迟）。

## 为什么需要延迟？

### 如果不延迟会发生什么？

假设10线程并发，每个线程延迟0.1秒：
- 每个线程每分钟调用：60秒 / 0.1秒 = 600次
- 10线程合计：600次 × 10 = 6000次/分钟
- **远超限制**：6000次 >> 200次/分钟

结果：API调用失败，返回"每分钟最多访问该接口200次"的错误。

### 正确的延迟策略

10线程并发，每个线程延迟3秒：
- 每个线程每分钟调用：60秒 / 3秒 = 20次
- 10线程合计：20次 × 10 = 200次/分钟
- **符合限制**：200次 = 200次/分钟 ✅

## 优化建议

### 1. 降低并发数（如果延迟太慢）

如果觉得3秒/次太慢，可以：
- 降低并发线程数：从10线程降到5线程
- 延迟变为：1.5秒/次（更快）
- 但总速度会变慢（因为并发数少了）

### 2. 使用缓存（推荐）

- 公司信息：30天缓存，大幅减少API调用
- 财务数据：24小时缓存，第二次查询秒开

### 3. 单线程模式（最快延迟）

- 单线程：0.3秒/次（最快）
- 但总速度最慢（因为只有1个线程）

## 当前配置（2000分，10线程）

- **财务数据API**：3.0秒/次（10线程并发）
- **公司信息API**：6.0秒/次（保守策略）
- **额外延迟**：0秒（可选）

## 总结

**规则不是要求慢，而是要求合理分配**：
- 单线程：0.3秒/次（很快）
- 10线程：3秒/次（合理分配，总速度更快）
- 20线程：6秒/次（更慢，但总速度可能更快）

**关键**：延迟是为了确保所有线程加起来不超过全局限制，而不是让每个线程都慢。

